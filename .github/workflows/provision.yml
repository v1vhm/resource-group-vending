# yamllint disable rule:line-length rule:truthy
---
name: Provision Environment

on:
  workflow_dispatch:
    inputs:
      product_name:
        description: 'Product name'
        required: true
      product_short_name:
        description: 'Short name used for the file name'
        required: true
      location:
        description: 'Azure region'
        required: true
        default: 'eastus'
      environment:
        description: 'Environment'
        required: true
        default: 'dev'
      product_identifier:
        description: 'Product identifier'
        required: true
      port_context:
        required: true
        description: Includes the action's run id
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  prepare:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      id-token: write
      contents: write
    env:
      ARM_USE_OIDC: true
      ARM_CLIENT_ID: ${{ secrets.AZURECLIENTID }}
      ARM_TENANT_ID: ${{ secrets.AZURETENANTID }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURESUBSCRIPTIONID }}
      PORT_RUN_ID: ${{ fromJson(inputs.port_context).runId }}
      TF_VAR_port_run_id: ${{ fromJson(inputs.port_context).runId }}
      PORT_CLIENT_ID: ${{ secrets.PORT_CLIENT_ID }}
      PORT_CLIENT_SECRET: ${{ secrets.PORT_CLIENT_SECRET }}
    outputs:
      environment_file: ${{ steps.create_env_file.outputs.path }}
      container_name: ${{ steps.compute_container.outputs.name }}
      state_file_container_id: ${{ steps.compute_state_container_id.outputs.id }}
    steps:
      - name: Start run
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{ env.PORT_RUN_ID }}
          logMessage: 'Preparing ${{ inputs.product_name }} in ${{ inputs.location }} (${{ inputs.environment }})'

      - uses: actions/checkout@v5

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURECLIENTID }}
          tenant-id: ${{ secrets.AZURETENANTID }}
          subscription-id: ${{ secrets.AZURESUBSCRIPTIONID }}

      - name: Check for existing environment file
        id: check_env
        run: |
          FILE_NAME=$(echo "${{ inputs.product_short_name }}_${{ inputs.environment }}_${{ inputs.location }}" | tr '[:upper:]' '[:lower:]')
          if [ -f "environments/${FILE_NAME}.yaml" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Log existing environment file
        if: steps.check_env.outputs.exists == 'true'
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{ env.PORT_RUN_ID }}
          logMessage: 'Product environment file already exists'

      - name: Stop if environment file exists
        if: steps.check_env.outputs.exists == 'true'
        run: exit 1

      - name: Derive environment identifiers
        run: |
          ENVIRONMENT_IDENTIFIER=$(echo "${{ inputs.product_identifier }}_${{ inputs.environment }}_${{ inputs.location }}" | tr '[:upper:]' '[:lower:]' | tr ' ' '_')
          ENVIRONMENT_TITLE="${{ inputs.product_name }} ${{ inputs.environment }}"
          echo "ENVIRONMENT_IDENTIFIER=$ENVIRONMENT_IDENTIFIER" >> $GITHUB_ENV
          echo "ENVIRONMENT_TITLE=$ENVIRONMENT_TITLE" >> $GITHUB_ENV

      - name: Create environment file
        id: create_env_file
        run: |
          mkdir -p environments
          FILE_NAME=$(echo "${{ inputs.product_short_name }}_${{ inputs.environment }}_${{ inputs.location }}" | tr '[:upper:]' '[:lower:]')
          FILE_PATH="environments/${FILE_NAME}.yaml"
          cat <<EOF > $FILE_PATH
          environment_identifier: $ENVIRONMENT_IDENTIFIER
          environment_title: $ENVIRONMENT_TITLE
          location: ${{ inputs.location }}
          environment: ${{ inputs.environment }}
          product_name: ${{ inputs.product_name }}
          product_identifier: ${{ inputs.product_identifier }}
          port_run_id: $PORT_RUN_ID
          EOF
          echo "path=$FILE_PATH" >> $GITHUB_OUTPUT

      - name: Mark environment in progress
        run: |
          set -euo pipefail
          IFS=$'\n\t'
          echo "status: in_progress" >> "${{ steps.create_env_file.outputs.path }}"

      - name: Commit environment file
        run: |
          git config user.email "75343302+getport-io[bot]@users.noreply.github.com"
          git config user.name "getport-io[bot]"
          git add ${{ steps.create_env_file.outputs.path }}
          FILE_BASENAME=$(basename "${{ steps.create_env_file.outputs.path }}" .yaml)
          git commit -m "Add environment $FILE_BASENAME"
          git push origin HEAD:main

      - name: Compute container name
        id: compute_container
        run: |
          CONTAINER_NAME=$(echo "${{ inputs.product_short_name }}${{ inputs.environment }}${{ inputs.location }}" | tr '[:upper:]' '[:lower:]' | tr ' _' '-')
          echo "name=$CONTAINER_NAME" >> $GITHUB_OUTPUT
          echo "CONTAINER_NAME=$CONTAINER_NAME" >> $GITHUB_ENV

      - name: Create state container
        run: |
          az storage container create \
            --name $CONTAINER_NAME \
            --account-name vendingtfstate \
            --resource-group v1vhm-rg-vending-prod-uks-001 \
            --auth-mode login
      - name: Compute state container id
        id: compute_state_container_id
        run: |
          STATE_FILE_CONTAINER_ID=$(echo "vendingtfstate-${CONTAINER_NAME}" | tr '[:upper:]' '[:lower:]')
          echo "STATE_FILE_CONTAINER_ID=$STATE_FILE_CONTAINER_ID" >> $GITHUB_ENV
          echo "id=$STATE_FILE_CONTAINER_ID" >> $GITHUB_OUTPUT
      - name: Upsert state container
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: UPSERT
          blueprint: azureStorageContainer
          identifier: ${{ env.STATE_FILE_CONTAINER_ID }}
          title: ${{ env.CONTAINER_NAME }}
          relations: >-
            {"storageAccount": "/subscriptions/${{ env.ARM_SUBSCRIPTION_ID }}/resourcegroups/v1vhm-rg-vending-prod-uks-001/providers/microsoft.storage/storageaccounts/vendingtfstate"}
          properties: '{}'
      - name: Log preparation complete
        if: success()
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{ env.PORT_RUN_ID }}
          logMessage: 'Prepared ${{ steps.create_env_file.outputs.path }} and container ${{ steps.compute_container.outputs.name }}'

      - name: Log preparation failure
        if: failure()
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{ env.PORT_RUN_ID }}
          logMessage: 'Preparation stage failed for ${{ inputs.product_name }} in ${{ inputs.location }} (${{ inputs.environment }})'

  plan:
    needs: prepare
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      id-token: write
      contents: write
    env:
      ARM_USE_OIDC: true
      ARM_CLIENT_ID: ${{ secrets.AZURECLIENTID }}
      ARM_TENANT_ID: ${{ secrets.AZURETENANTID }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURESUBSCRIPTIONID }}
      PORT_RUN_ID: ${{ fromJson(inputs.port_context).runId }}
      TF_VAR_port_run_id: ${{ fromJson(inputs.port_context).runId }}
      PORT_CLIENT_ID: ${{ secrets.PORT_CLIENT_ID }}
      PORT_CLIENT_SECRET: ${{ secrets.PORT_CLIENT_SECRET }}
      TF_VAR_environment_file: ${{ github.workspace }}/${{ needs.prepare.outputs.environment_file }}
      CONTAINER_NAME: ${{ needs.prepare.outputs.container_name }}
    outputs:
      plan_path: ${{ steps.plan.outputs.path }}
      plan_summary: ${{ steps.summarize.outputs.summary }}
    steps:
      - name: Log start plan
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{ env.PORT_RUN_ID }}
          logMessage: 'Starting plan stage for ${{ inputs.product_name }} in ${{ inputs.location }} (${{ inputs.environment }})'

      - uses: actions/checkout@v5
        with:
          ref: main

      - name: Verify environment file
        run: test -f "$TF_VAR_environment_file"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURECLIENTID }}
          tenant-id: ${{ secrets.AZURETENANTID }}
          subscription-id: ${{ secrets.AZURESUBSCRIPTIONID }}

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Terraform Init
        run: |
          terraform -chdir=terraform init \
            -backend-config="resource_group_name=v1vhm-rg-vending-prod-uks-001" \
            -backend-config="storage_account_name=vendingtfstate" \
            -backend-config="container_name=${CONTAINER_NAME}" \
            -backend-config="key=${{ inputs.product_identifier }}_${{ inputs.environment }}_${{ inputs.location }}.tfstate" \
            -reconfigure

      # Set TF_LOG_LEVEL (e.g., TRACE) to capture detailed Terraform logs
      - name: Terraform Plan
        id: plan
        run: ./scripts/terraform-run.sh plan tfplan plan.log

      - name: Summarize Plan
        if: success()
        id: summarize
        run: |
          terraform -chdir=terraform show -json tfplan | jq -r '.resource_changes[] | "- " + .address + ": " + (.change.actions|join(", "))' > plan_summary.txt
          cat plan_summary.txt
          echo "summary<<EOF" >> $GITHUB_OUTPUT
          cat plan_summary.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Upload plan
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: tfplan
          path: terraform/tfplan

      - name: Log plan completion
        if: success()
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{ env.PORT_RUN_ID }}
          logMessage: ${{ steps.summarize.outputs.summary }}

      - name: Log plan failure
        if: failure()
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{ env.PORT_RUN_ID }}
          logMessage: "Plan stage failed: ${{ steps.plan.outputs.log }}"

  apply:
    needs: [prepare, plan]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      id-token: write
      contents: write
    env:
      ARM_USE_OIDC: true
      ARM_CLIENT_ID: ${{ secrets.AZURECLIENTID }}
      ARM_TENANT_ID: ${{ secrets.AZURETENANTID }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURESUBSCRIPTIONID }}
      PORT_RUN_ID: ${{ fromJson(inputs.port_context).runId }}
      TF_VAR_port_run_id: ${{ fromJson(inputs.port_context).runId }}
      PORT_CLIENT_ID: ${{ secrets.PORT_CLIENT_ID }}
      PORT_CLIENT_SECRET: ${{ secrets.PORT_CLIENT_SECRET }}
      TF_VAR_environment_file: ${{ github.workspace }}/${{ needs.prepare.outputs.environment_file }}
      CONTAINER_NAME: ${{ needs.prepare.outputs.container_name }}
      STATE_FILE_CONTAINER_ID: ${{ needs.prepare.outputs.state_file_container_id }}
    outputs:
      commit_sha: ${{ steps.commit.outputs.sha }}
    steps:
      - name: Log start apply
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{ env.PORT_RUN_ID }}
          logMessage: 'Starting apply stage for ${{ inputs.product_name }} in ${{ inputs.location }} (${{ inputs.environment }})'

      - uses: actions/checkout@v5
        with:
          ref: main

      - name: Verify environment file
        run: test -f "$TF_VAR_environment_file"

      - uses: actions/download-artifact@v5
        with:
          name: tfplan
          path: terraform

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURECLIENTID }}
          tenant-id: ${{ secrets.AZURETENANTID }}
          subscription-id: ${{ secrets.AZURESUBSCRIPTIONID }}

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Log start terraform init
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{ env.PORT_RUN_ID }}
          logMessage: 'Starting Terraform Init'

      - name: Terraform Init
        run: |
          terraform -chdir=terraform init \
            -backend-config="resource_group_name=v1vhm-rg-vending-prod-uks-001" \
            -backend-config="storage_account_name=vendingtfstate" \
            -backend-config="container_name=${CONTAINER_NAME}" \
            -backend-config="key=${{ inputs.product_identifier }}_${{ inputs.environment }}_${{ inputs.location }}.tfstate" \
            -reconfigure

      - name: Log start terraform apply
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{ env.PORT_RUN_ID }}
          logMessage: 'Starting Terraform Apply'

      # Set TF_LOG_LEVEL (e.g., TRACE) to capture detailed Terraform logs
      - name: Terraform Apply
        id: apply
        run: ./scripts/terraform-run.sh apply tfplan apply.log

      - name: Log apply output
        if: success()
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{ env.PORT_RUN_ID }}
          logMessage: ${{ steps.apply.outputs.log }}

      - name: Capture outputs
        run: |
          set -euo pipefail
          IFS=$'\n\t'
          terraform -chdir=terraform output -json > tfoutput.json
          for key in deployment_environment deployment_identity azure_subscription state_file_container user_managed_identity_client_id; do
            value=$(jq -r ".${key}.value" tfoutput.json)
            varname=$(echo "$key" | tr '[:lower:]' '[:upper:]')
            echo "${varname}=$value" >> "$GITHUB_ENV"
          done

      - uses: actions/upload-artifact@v4
        with:
          name: tfoutput
          path: tfoutput.json

      - name: Append outputs to environment file
        run: |
          {
            echo "deployment_environment: $DEPLOYMENT_ENVIRONMENT"
            echo "deployment_identity: $DEPLOYMENT_IDENTITY"
            echo "azure_subscription: $AZURE_SUBSCRIPTION"
            echo "state_file_container: $STATE_FILE_CONTAINER"
          } >> "$TF_VAR_environment_file"

      - name: Commit updated environment file
        id: commit
        run: |
          git config user.email "75343302+getport-io[bot]@users.noreply.github.com"
          git config user.name "getport-io[bot]"
          git add $TF_VAR_environment_file
          FILE_BASENAME=$(basename "$TF_VAR_environment_file" .yaml)
          git commit -m "Update environment $FILE_BASENAME with outputs"
          git push origin HEAD:main
          echo "sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"

      - name: Mark apply success
        if: success()
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{ env.PORT_RUN_ID }}
          logMessage: >-
            Terraform apply complete for env=${{ env.DEPLOYMENT_ENVIRONMENT }},
            identity=${{ env.DEPLOYMENT_IDENTITY }},
            subscription=${{ env.AZURE_SUBSCRIPTION }}

      - name: Mark apply failure
        if: failure()
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{ env.PORT_RUN_ID }}
          logMessage: "Apply stage failed: ${{ steps.apply.outputs.log }}"

  finalize:
    needs: [apply, prepare]
    if: ${{ always() }}
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: write
    env:
      PORT_RUN_ID: ${{ fromJson(inputs.port_context).runId }}
      PORT_CLIENT_ID: ${{ secrets.PORT_CLIENT_ID }}
      PORT_CLIENT_SECRET: ${{ secrets.PORT_CLIENT_SECRET }}
      ENV_FILE: ${{ needs.prepare.outputs.environment_file }}
    steps:
      - uses: actions/checkout@v5
        with:
          ref: main

      - name: Load deployment metadata
        run: |
          DEPLOYMENT_ENVIRONMENT=$(grep '^deployment_environment:' "$ENV_FILE" | awk '{print $2}')
          DEPLOYMENT_IDENTITY=$(grep '^deployment_identity:' "$ENV_FILE" | awk '{print $2}')
          AZURE_SUBSCRIPTION=$(grep '^azure_subscription:' "$ENV_FILE" | awk '{print $2}')
          STATE_FILE_CONTAINER=$(grep '^state_file_container:' "$ENV_FILE" | awk '{print $2}')
          test -n "$DEPLOYMENT_ENVIRONMENT" && test -n "$DEPLOYMENT_IDENTITY" && test -n "$AZURE_SUBSCRIPTION" && test -n "$STATE_FILE_CONTAINER"
          {
            echo "DEPLOYMENT_ENVIRONMENT=$DEPLOYMENT_ENVIRONMENT"
            echo "DEPLOYMENT_IDENTITY=$DEPLOYMENT_IDENTITY"
            echo "AZURE_SUBSCRIPTION=$AZURE_SUBSCRIPTION"
            echo "STATE_FILE_CONTAINER=$STATE_FILE_CONTAINER"
          } >> "$GITHUB_ENV"

      - name: Log start finalize
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{ env.PORT_RUN_ID }}
          logMessage: >-
            Finalizing ${{ env.ENV_FILE }} with env=${{ env.DEPLOYMENT_ENVIRONMENT }},
            identity=${{ env.DEPLOYMENT_IDENTITY }},
            subscription=${{ env.AZURE_SUBSCRIPTION }}

      - name: Verify environment file
        run: test -f "$ENV_FILE"

      - name: Install yq
        run: sudo snap install yq --classic

      - name: Mark environment as succeeded
        if: ${{ success() }}
        run: yq e -i '.status = "succeeded"' "$ENV_FILE"

      - name: Mark environment as failed
        if: ${{ failure() }}
        run: yq e -i '.status = "failed"' "$ENV_FILE"

      - name: Commit finalized environment file
        if: ${{ always() }}
        run: |
          git config user.email "75343302+getport-io[bot]@users.noreply.github.com"
          git config user.name "getport-io[bot]"
          git add "$ENV_FILE"
          FILE_BASENAME=$(basename "$ENV_FILE" .yaml)
          git commit -m "Update environment $FILE_BASENAME status"
          git push origin HEAD:main

      - id: get_sha
        run: echo "sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"

      - name: Log finalize completion
        if: success()
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{ env.PORT_RUN_ID }}
          logMessage: >-
            Finalized ${{ env.ENV_FILE }} with commit ${{ steps.get_sha.outputs.sha }} and ids env=${{ env.DEPLOYMENT_ENVIRONMENT }},
            identity=${{ env.DEPLOYMENT_IDENTITY }},
            subscription=${{ env.AZURE_SUBSCRIPTION }}

      - name: Log finalize failure
        if: failure()
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{ env.PORT_RUN_ID }}
          logMessage: "Finalize stage failed"
